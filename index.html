<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEU ACM CF 实时统计</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        margin: 0;
        padding: 15px;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        background: #fff;
        padding: 20px 15px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin: 0 0 20px 0;
        font-size: 1.5rem;
      }

      .control-panel {
        display: flex;
        flex-direction: row;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: center;
      }

      .control-panel input[type="datetime-local"],
      .control-panel button {
        width: auto;
        min-width: 140px;
        max-width: 250px;
        height: 38px;
        padding: 0 10px;
        border-radius: 6px;
        font-size: 0.9rem;
        box-sizing: border-box;
      }

      .control-panel input[type="datetime-local"] {
        border: 1px solid #ced4da;
        font-family: inherit;
        color: #495057;
        flex: 2;
      }

      .control-panel button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 2;
      }

      .control-panel button:active {
        background-color: #0056b3;
      }

      .status-bar {
        background: #e9ecef;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
        color: #555;
        font-size: 0.9rem;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 350px;
      }

      th,
      td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid #dee2e6;
        white-space: nowrap;
        font-size: 0.95rem;
      }

      th {
        background-color: #343a40;
        color: #fff;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      a {
        color: #007bff;
        text-decoration: none;
        font-weight: 600;
      }

      a:hover {
        text-decoration: underline;
      }

      .user-black {
        color: black;
        font-weight: normal;
      }
      .user-gray {
        color: gray;
        font-weight: bold;
      }
      .user-green {
        color: green;
        font-weight: bold;
      }
      .user-cyan {
        color: #03a89e;
        font-weight: bold;
      }
      .user-blue {
        color: blue;
        font-weight: bold;
      }
      .user-violet {
        color: #a0a;
        font-weight: bold;
      }
      .user-orange {
        color: #ff8c00;
        font-weight: bold;
      }
      .user-red {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>NEU ACM CF 训练统计</h1>

      <div class="control-panel">
        <input type="datetime-local" id="startTime" value="2025-09-01T23:59" />
        <button id="runBtn" onclick="initiateProcess()">开始 / 刷新</button>
      </div>

      <div id="status" class="status-bar">点击上方按钮开始统计</div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>姓名</th>
              <th>Handle</th>
              <th>Rating</th>
              <th>统计场次</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const STATUS_DIV = document.getElementById("status");
      const TABLE_BODY = document.getElementById("resultBody");
      const RUN_BTN = document.getElementById("runBtn");
      const TIME_INPUT = document.getElementById("startTime");

      let currentRunId = 0;

      const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      function getRatingClass(rating, totalContests) {
        if (!rating || rating === "None") return "";

        if (totalContests !== undefined && totalContests <= 5) {
          return "user-black";
        }

        const r = parseInt(rating);
        if (isNaN(r)) return "";

        if (r < 1200) return "user-gray";
        if (r < 1400) return "user-green";
        if (r < 1600) return "user-cyan";
        if (r < 1900) return "user-blue";
        if (r < 2100) return "user-violet";
        if (r < 2400) return "user-orange";
        return "user-red";
      }

      async function loadHandleCSV() {
        try {
          const response = await fetch("handle.csv");
          if (!response.ok) throw new Error("无法读取 handle.csv");

          const text = await response.text();
          const lines = text.trim().split("\n");
          const users = [];

          for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(",");
            if (row.length >= 2) {
              users.push({
                name: row[0].trim(),
                handle: row[1].trim(),
              });
            }
          }
          return users;
        } catch (err) {
          STATUS_DIV.innerHTML = `<span style="color:red">错误：${err.message} <br> 请确保使用 http 服务器运行</span>`;
          return [];
        }
      }

      async function fetchUserData(user, deadlineTimestamp) {
        const url = `https://codeforces.com/api/user.rating?handle=${user.handle}`;

        try {
          const response = await fetch(url);
          const data = await response.json();

          if (data.status === "OK") {
            const contests = data.result;
            const totalContests = contests.length;

            if (totalContests === 0) {
              return {
                ...user,
                total: 0,
                after: 0,
                cur: null,
                error: "无数据",
              };
            }

            const afterContests = contests.filter(
              (c) => c.ratingUpdateTimeSeconds > deadlineTimestamp
            );

            const countAfter = afterContests.length;
            const latestRating = contests[contests.length - 1].newRating;

            return {
              ...user,
              total: totalContests,
              after: countAfter,
              cur: latestRating,
              error: null,
            };
          } else {
            return { ...user, error: data.comment || "API 错误" };
          }
        } catch (err) {
          console.error(err);
          return { ...user, error: "网络/跨域错误" };
        }
      }

      function renderRow(data) {
        const tr = document.createElement("tr");

        if (data.error) {
          tr.innerHTML = `
                <td>${data.name}</td>
                <td>
                    <a href="https://codeforces.com/profile/${data.handle}" target="_blank">${data.handle}</a>
                </td>
                <td colspan="2" style="color: red;">${data.error}</td>
            `;
        } else {
          const curClass = getRatingClass(data.cur, data.total);

          tr.innerHTML = `
                <td>${data.name}</td>
                <td>
                    <a href="https://codeforces.com/profile/${data.handle}" target="_blank" class="${curClass}">${data.handle}</a>
                </td>
                <td class="${curClass}">${data.cur}</td>
                <td><strong>${data.after}</strong></td>
            `;
        }
        TABLE_BODY.appendChild(tr);
      }

      async function initiateProcess() {
        currentRunId++;
        const thisRunId = currentRunId;

        TABLE_BODY.innerHTML = "";

        const timeVal = TIME_INPUT.value;
        const deadlineDate = new Date(timeVal);
        const deadlineTimestamp = Math.floor(deadlineDate.getTime() / 1000);

        const users = await loadHandleCSV();
        if (users.length === 0) return;

        STATUS_DIV.textContent = `读取成功，共 ${users.length} 人，开始获取数据...`;
        STATUS_DIV.style.backgroundColor = "#e9ecef";
        STATUS_DIV.style.color = "#555";

        for (let i = 0; i < users.length; i++) {
          if (thisRunId !== currentRunId) return;

          const user = users[i];
          STATUS_DIV.textContent = `正在查询 (${i + 1}/${users.length}): ${
            user.name
          }`;

          const result = await fetchUserData(user, deadlineTimestamp);

          if (thisRunId !== currentRunId) return;
          renderRow(result);

          await sleep(50);
        }

        if (thisRunId === currentRunId) {
          STATUS_DIV.textContent = "统计完成";
          STATUS_DIV.style.backgroundColor = "#d4edda";
          STATUS_DIV.style.color = "#155724";
        }
      }

      initiateProcess();
    </script>
  </body>
</html>
